{% extends "layout.html" %}
{% block title %}Главная страница{% endblock %}
{% block body %}
    <div class="row">
        <div class="col-xs-10 col-xs-offset-1">
            {% if data %}
                <h3>Список</h3>
                {{ pagination.info }}
                <div align="left">{{ pagination.links }}</div>
                <div id="pagesize" style="font-size: small" align="right">Показывать по <a href="/?id=10" style="cursor: pointer">10</a> <a href="/?id=20" style="cursor: pointer">20</a> <a href="/?id=50" style="cursor: pointer">50</a></div>
                <table class="table table-condensed table-hover" id="example">
                    <thead>
                    <tr>
                        <th><input type="checkbox" id="selectAll"/></th>
                        <th>#</th>
                        <th>Наименование организации</th>
                        <th>Электронная почта</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for object in data %}
                        <tr id="{{object.id}}">
                            <td><input type="checkbox" name="optradio"></td>
                            <td>{{ loop.index + (page - 1) * per_page }}</td>
                            <td>
                                {{ object.name }}
                            </td>
                            <td>
                                {{ object.mails }}
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
                {{ pagination.links }}<br>
                <button class="btn btn-success disabled" disabled="disabled" id="button_send">Отправить</button>
                <button class="btn btn-danger" disabled="disabled" id="button_delete">Удалить</button>
                <p id="out"></p>
            {% endif %}
        </div>
    </div>
    <div class="modal fade" tabindex="-1" role="dialog" id="modal-delete">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Подтвердите удаление</h4>
                </div>
                <div class="modal-body">
                    <p id="text-modal"></p>
                </div>
                <div class="modal-footer">
                    <form method="post">
                        <input type="hidden" id="list_id_del" name="list_id_del" value="">
                        <input type="submit" class="btn btn-danger" value="Да">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Нет</button>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <div class="modal fade" tabindex="-1" role="dialog" id="modal-send">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Подтвердите отправку почты</h4>
                </div>
                <div class="modal-body">
                    <p id="text-org"></p>
                </div>
                <div class="modal-footer">
                    <form method="post">
                        <input type="hidden" id="list_id" name="list_id" value="">
                        <input type="submit" class="btn btn-success" value="Да">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Нет</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        $('#selectAll').click(function (e) {
            var table = $(e.target).closest('table');
            $('td input:checkbox', table).prop('checked', this.checked);
        });
        $('#button_send').click(function () {
            var selectedIds = [];
            var selectedName = [];
            $('#example tr').filter(':has(:checkbox:checked)').each(function () {
                var i = parseInt($(this).closest('tr').attr('id'));
                if (!isNaN(i)) {
                    console.log(i)
                    selectedIds.push(i);
                }
                if ($(this).closest('tr').children('td')[2] !== undefined) {
                    selectedName.push($(this).closest('tr').children('td')[2].innerText)
                }
            });
            var link = '/send';
            var dialog = $('#modal-send');
            dialog.find('form').attr('action', link);

            dialog.modal('show');
            document.getElementById("text-org").textContent = selectedName;
            document.getElementById("text-org").innerHTML = document.getElementById("text-org").textContent.replaceAll(",", "<br>")
            $('#list_id').val(selectedIds)

        });

        $('#button_delete').click(function () {
            var selectedIds = [];
            var selectedName = [];
            $('#example tr').filter(':has(:checkbox:checked)').each(function () {
                selectedIds.push($(this).closest('tr').attr('id'));
                if (selectedIds[0] == undefined) {
                    selectedIds.splice(0, 1)
                }
                if ($(this).closest('tr').children('td')[2] != undefined) {
                    selectedName.push($(this).closest('tr').children('td')[2].innerText)
                }
            });
            var link = '/delete';
            var dialog = $('#modal-delete');
            dialog.find('form').attr('action', link);

            dialog.modal('show');
            document.getElementById("text-modal").textContent = selectedName;
            document.getElementById("text-modal").innerHTML = document.getElementById("text-modal").textContent.replaceAll(",", "<br>")
            console.log(document.getElementById("text-modal").innerHTML)
            $('#list_id_del').val(selectedIds)
        });
        String.prototype.replaceAll = function (token, newToken, ignoreCase) {
            var _token;
            var str = this + "";
            var i = -1;
            if (typeof token === "string") {
                if (ignoreCase) {
                    _token = token.toLowerCase();
                    while ((
                        i = str.toLowerCase().indexOf(
                            _token, i >= 0 ? i + newToken.length : 0
                        ) ) !== -1
                        ) {
                        str = str.substring(0, i) +
                            newToken +
                            str.substring(i + token.length);
                    }
                } else {
                    return this.split(token).join(newToken);
                }
            }
            return str;
        };
        $('input[type=checkbox]').change(function () {
            var len = $('input[type=checkbox]:checked').length
            if (len>0) {
                $('#button_send').attr("disabled", false).removeClass('disabled');
                $('#button_delete').attr("disabled", false).removeClass('disabled');
            }
            else {
                $("#button_send").attr("disabled", true).addClass('disabled');
                $('#button_delete').attr("disabled", true).addClass('disabled');
            }
{#            selectedIds.push();#}
{#            console.log(selectedIds)#}
{#            $.each(selectedIds, function (index, id) {#}
{#                selectedIds.splice(id,1);#}
{#            });#}
        });
    </script>
{% endblock %}
